<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nano IA Offline</title>
    <style>
        :root { --primary: #007bff; --bg: #f0f2f5; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Cabe√ßalho Otimizado */
        #header { background: #fff; padding: 15px; border-bottom: 1px solid #ddd; z-index: 10; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 18px; margin: 0; color: var(--primary); }
        
        /* Barra de Progresso */
        .progress-box { margin-top: 10px; display: none; }
        .bar-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        #bar-fill { width: 0%; height: 100%; background: var(--primary); transition: width 0.2s; }
        #status { font-size: 12px; color: #666; margin-top: 4px; display: block; }

        /* Chat */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 15px; max-width: 80%; font-size: 15px; line-height: 1.4; }
        .user { align-self: flex-end; background: var(--primary); color: #fff; border-bottom-right-radius: 2px; }
        .ai { align-self: flex-start; background: #fff; border: 1px solid #ddd; border-bottom-left-radius: 2px; }

        /* Input Fixo embaixo */
        #controls { background: #fff; padding: 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; }
        input { flex: 1; border: 1px solid #ccc; padding: 12px; border-radius: 25px; outline: none; font-size: 16px; }
        button { border: none; border-radius: 20px; padding: 10px 15px; font-weight: bold; cursor: pointer; }
        #send { background: var(--primary); color: #fff; }
        #send:disabled { background: #ccc; }
        #clear { background: #ff4757; color: #fff; font-size: 10px; }
    </style>
</head>
<body>

<div id="header">
    <div class="top-row">
        <h1>Nano IA ü§ñ</h1>
        <button id="clear">Limpar Cache</button>
    </div>
    <div class="progress-box" id="p-box">
        <div class="bar-bg"><div id="bar-fill"></div></div>
        <span id="status">Iniciando...</span>
    </div>
</div>

<div id="chat">
    <div class="msg ai">Ol√°! Eu sou uma IA que roda localmente. Na primeira vez, vou baixar meus "conhecimentos" (360MB). Depois disso, funcionarei sem internet!</div>
</div>

<div id="controls">
    <input type="text" id="input" placeholder="Digite em ingl√™s..." autocomplete="off">
    <button id="send" disabled>Enviar</button>
</div>

<script type="module">
    // Importando a biblioteca principal
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

    // Configura√ß√µes para Celular (For√ßa uso de mem√≥ria local e desabilita WebGPU se falhar)
    env.allowLocalModels = false;
    env.useBrowserCache = true;

    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const btn = document.getElementById('send');
    const pBox = document.getElementById('p-box');
    const fill = document.getElementById('bar-fill');
    const status = document.getElementById('status');
    const clearBtn = document.getElementById('clear');

    let generator;

    // Fun√ß√£o para carregar o modelo
    async function loadModel() {
        pBox.style.display = 'block';
        try {
            generator = await pipeline('text-generation', 'Xenova/SmolLM-135M-Instruct', {
                progress_callback: (data) => {
                    if (data.status === 'progress') {
                        fill.style.width = `${data.progress}%`;
                        status.innerText = `Baixando IA: ${Math.round(data.progress)}%`;
                    }
                    if (data.status === 'ready') {
                        pBox.style.display = 'none';
                        status.innerText = "IA Pronta Offline";
                        btn.disabled = false;
                    }
                }
            });
        } catch (err) {
            status.innerText = "Erro ao carregar. Tente atualizar a p√°gina.";
            console.error(err);
        }
    }

    // Fun√ß√£o de enviar mensagem
    async function handleSend() {
        const text = input.value.trim();
        if (!text) return;

        addMsg(text, 'user');
        input.value = '';
        btn.disabled = true;

        try {
            const output = await generator(text, { 
                max_new_tokens: 50,
                temperature: 0.7,
                repetition_penalty: 1.2 
            });
            const response = output[0].generated_text.replace(text, '').trim();
            addMsg(response || "N√£o entendi, pode repetir?", 'ai');
        } catch (e) {
            addMsg("Erro ao processar. Tente frases curtas.", 'ai');
        }
        btn.disabled = false;
    }

    function addMsg(txt, side) {
        const d = document.createElement('div');
        d.className = `msg ${side}`;
        d.innerText = txt;
        chat.appendChild(d);
        chat.scrollTop = chat.scrollHeight;
    }

    // Bot√£o Limpar Cache
    clearBtn.onclick = async () => {
        if(confirm("Apagar os 360MB da IA do seu celular?")) {
            const dbs = await indexedDB.databases();
            dbs.forEach(db => indexedDB.deleteDatabase(db.name));
            alert("Mem√≥ria limpa!");
            location.reload();
        }
    }

    btn.onclick = handleSend;
    input.onkeypress = (e) => e.key === 'Enter' && handleSend();

    loadModel();
</script>

</body>
</html>
